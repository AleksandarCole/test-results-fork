version: v1.0
name: Build
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Unit Test
    dependencies: []
    task:
      prologue:
        commands:
          - sem-version go 1.16
          - "export GOPATH=~/go"
          - "export PATH=/home/semaphore/go/bin:$PATH"
          - checkout
          - go get ./...
          - go get -u gotest.tools/gotestsum
      jobs:
        - name: "Test"
          commands:
            - gotestsum --junitfile /tmp/junit.xml

      epilogue:
        always:
          commands:
            - cd /tmp
            - test-results publish junit.xml
  - name: Build
    dependencies: []
    task:
      prologue:
        commands:
          - sem-version go 1.16
          - "export GOPATH=~/go"
          - "export PATH=/home/semaphore/go/bin:$PATH"
          - checkout
      jobs:
        - name: Build
          commands:
            - make build
            - artifact push workflow bin/test-results -d bin/test-results

  - name: Integration tests
    dependencies:
      - Build
    task:
      prologue:
        commands:
          - artifact pull workflow bin/test-results -d /tmp/test-results
          - sudo mv /tmp/test-results /usr/local/bin/test-results
          - sudo chmod +x /usr/local/bin/test-results
          - test-results --version
          - checkout
      jobs:
        - name: "Parsers"
          matrix:
              - env_var: PARSER
                values: ["generic", "rspec", "golang", "exunit"]
          commands:
            - test-results publish priv/parsers/$PARSER/in.xml
            - artifact pull job test-results/junit.json -d /tmp/junit.json
            - diff priv/parsers/$PARSER/out.json /tmp/junit.json
        - name: "Merging - directory as input"
          commands:
            - test-results publish priv/merging
            - artifact pull job test-results/junit.json -d /tmp/junit.json
            - diff priv/merging/out.json /tmp/junit.json

  - name: Integration tests - workflow level
    dependencies:
      - Integration tests
    task:
      prologue:
        commands:
          - artifact pull workflow bin/test-results -d /tmp/test-results
          - sudo mv /tmp/test-results /usr/local/bin/test-results
          - sudo chmod +x /usr/local/bin/test-results
          - checkout
      jobs:
        - name: "Test"
          commands:
            - test-results gen-pipeline-report
            - artifact pull workflow test-results/junit.json -d /tmp/junit.json
            - diff /tmp/junit.json priv/workflow/out.json


promotions:
    - name: Release
      pipeline_file: goreleaser.yml
      auto_promote_on:
        - result: passed
          branch:
            - "^refs/tags/v*"
